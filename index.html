<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description"
        content="World of Love ‚Äî Un jeu de cartes bas√© sur 196 pays. Collectionnez, √©changez et am√©liorez vos cartes !">
    <meta name="theme-color" content="#ff6b9d">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WorldLove">

    <!-- Open Graph / Partage social -->
    <meta property="og:title" content="World of Love ‚Äî Card Game">
    <meta property="og:description" content="Jeu de cartes bas√© sur 196 pays. Collectionnez, √©changez et am√©liorez !">
    <meta property="og:type" content="website">
    <meta property="og:image" content="icons/icon-512.svg">

    <title>World of Love ‚Äî Card Game</title>

    <!-- Favicon emoji -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíï</text></svg>">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Ic√¥nes Apple -->
    <link rel="apple-touch-icon" href="icons/icon-192.svg">

    <!-- Styles -->
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app">
        <!-- Header (cach√© sur login) -->
        <header id="header">
            <div class="logo">
                <span class="logo-icon">üíï</span>
                <span>World of Love</span>
            </div>

            <!-- Bouton d'installation PWA -->
            <button id="install-btn" class="install-btn" style="display: none;" aria-label="Installer l'application">
                <span class="install-icon">üì≤</span>
                <span class="install-text">Installer</span>
            </button>

            <nav>
                <button class="nav-item active" data-page="home">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Accueil</span>
                </button>
                <button class="nav-item" data-page="collection">
                    <span class="nav-icon">üé¥</span>
                    <span class="nav-text">Collection</span>
                </button>
                <button class="nav-item" data-page="shop">
                    <span class="nav-icon">üõí</span>
                    <span class="nav-text">Boutique</span>
                </button>
                <button class="nav-item" data-page="missions">
                    <span class="nav-icon">üìã</span>
                    <span class="nav-text">Missions</span>
                </button>
                <button class="nav-item" data-page="profile">
                    <span class="nav-icon">üë§</span>
                    <span class="nav-text">Profil</span>
                </button>
            </nav>
        </header>

        <!-- Contenu principal -->
        <main id="main-content">
            <!-- Le contenu est g√©n√©r√© dynamiquement par JavaScript -->
            <div class="loading">
                <span>üíï</span>
                <p>Chargement...</p>
            </div>
        </main>
    </div>

    <!-- Container pour les toasts -->
    <div id="toast-container"></div>

    <!-- ================================================================== -->
    <!-- iOS Error Handling & Loading Timeout (AVANT le script principal) -->
    <!-- ================================================================== -->
    <script>
        (function () {
            'use strict';

            // =============================================================
            // 1) GESTION GLOBALE DES ERREURS (iOS debugging)
            // =============================================================
            var appLoaded = false;
            var errors = [];

            function showErrorPopup(title, message) {
                // √âviter les doublons
                if (document.getElementById('ios-error-popup')) return;

                var popup = document.createElement('div');
                popup.id = 'ios-error-popup';
                popup.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);color:#fff;padding:20px;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:system-ui,sans-serif;text-align:center;';
                popup.innerHTML =
                    '<h2 style="color:#ff6b9d;margin-bottom:15px;">‚ö†Ô∏è ' + title + '</h2>' +
                    '<p style="max-width:90%;word-break:break-word;margin-bottom:20px;font-size:14px;">' + message + '</p>' +
                    '<div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">' +
                    '<button onclick="location.reload()" style="padding:12px 24px;background:#ff6b9d;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer;">üîÑ Recharger</button>' +
                    '<button onclick="location.href=location.pathname+\'?sw=0\'" style="padding:12px 24px;background:#333;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer;">üîß Mode Debug</button>' +
                    '</div>' +
                    '<p style="margin-top:20px;font-size:12px;opacity:0.7;">Si le probl√®me persiste, essayez de vider le cache Safari</p>';
                document.body.appendChild(popup);
            }

            // Capturer les erreurs globales
            window.onerror = function (message, source, lineno, colno, error) {
                var errMsg = message + ' (ligne ' + lineno + ')';
                errors.push(errMsg);
                console.error('‚ùå Erreur JS:', errMsg, source);

                // Afficher seulement si l'app n'a pas encore charg√©
                if (!appLoaded) {
                    showErrorPopup('Erreur de chargement', errMsg);
                }
                return false;
            };

            // Capturer les promesses rejet√©es non g√©r√©es
            window.addEventListener('unhandledrejection', function (event) {
                var reason = event.reason ? (event.reason.message || String(event.reason)) : 'Erreur inconnue';
                errors.push('Promise: ' + reason);
                console.error('‚ùå Promise rejet√©e:', reason);

                if (!appLoaded) {
                    showErrorPopup('Erreur de chargement', 'Promise rejet√©e: ' + reason);
                }
            });

            // =============================================================
            // 2) TIMEOUT DE CHARGEMENT (10 secondes)
            // =============================================================
            var loadingTimeout = setTimeout(function () {
                if (!appLoaded) {
                    var errDetail = errors.length > 0
                        ? 'Erreurs d√©tect√©es: ' + errors.join(', ')
                        : 'L\'application ne r√©pond pas.';
                    showErrorPopup('Chargement bloqu√©', errDetail);
                }
            }, 10000);

            // Marquer l'app comme charg√©e quand initUI est appel√©
            window.__markAppLoaded = function () {
                appLoaded = true;
                clearTimeout(loadingTimeout);
            };

            // =============================================================
            // 3) NETTOYAGE DU LOADING SPINNER
            // =============================================================
            window.addEventListener('load', function () {
                // Attendre un peu pour laisser le temps √† l'app de s'initialiser
                setTimeout(function () {
                    var loading = document.querySelector('.loading');
                    if (loading && appLoaded) {
                        loading.style.display = 'none';
                    }
                }, 500);
            });

            console.log('üõ°Ô∏è iOS Error Handler v1.0 charg√©');
        })();
    </script>

    <!-- Script principal (JavaScript compil√©) -->
    <script src="dist/main.js"></script>

    <!-- Script PWA : Service Worker + Installation -->
    <script>
        // ========================================================================
        // WORLD OF LOVE ‚Äî PWA SCRIPTS
        // ========================================================================

        // Variable pour stocker l'√©v√©nement d'installation
        let deferredPrompt = null;
        const installBtn = document.getElementById('install-btn');

        // --------------------------------------------------------------------
        // 1) Enregistrement du Service Worker (avec bypass ?sw=0)
        // --------------------------------------------------------------------
        const urlParams = new URLSearchParams(window.location.search);
        const swBypass = urlParams.get('sw') === '0';

        if (swBypass) {
            console.log('‚è© Service Worker d√©sactiv√© (mode debug ?sw=0)');
            // D√©sinscrire le SW existant si pr√©sent
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(reg => {
                        reg.unregister();
                        console.log('üóëÔ∏è Service Worker d√©sinscrit');
                    });
                });
            }
        } else if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./service-worker.js');
                    console.log('‚úÖ Service Worker enregistr√© avec succ√®s:', registration.scope);

                    // √âcouter les mises √† jour
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('üîÑ Nouvelle version du Service Worker trouv√©e...');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('‚ú® Mise √† jour disponible ! Rechargez pour appliquer.');
                                // Optionnel: afficher un toast pour informer l'utilisateur
                                showPWAToast('Mise √† jour disponible ! Rechargez la page.');
                            }
                        });
                    });

                } catch (error) {
                    console.error('‚ùå Erreur lors de l\'enregistrement du Service Worker:', error);
                }
            });
        }

        // --------------------------------------------------------------------
        // 2) Gestion de l'√©v√©nement beforeinstallprompt (Chrome/Edge/Android)
        // --------------------------------------------------------------------
        window.addEventListener('beforeinstallprompt', (e) => {
            // Emp√™cher l'affichage automatique du prompt
            e.preventDefault();

            // Stocker l'√©v√©nement pour l'utiliser plus tard
            deferredPrompt = e;

            // Afficher le bouton d'installation
            if (installBtn) {
                installBtn.style.display = 'flex';
                installBtn.classList.add('pulse');
                console.log('üì≤ Installation disponible ! Bouton affich√©.');
            }
        });

        // --------------------------------------------------------------------
        // 3) Clic sur le bouton d'installation
        // --------------------------------------------------------------------
        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) {
                    console.log('‚ö†Ô∏è L\'installation n\'est pas disponible.');
                    return;
                }

                // Afficher le prompt d'installation
                deferredPrompt.prompt();

                // Attendre la r√©ponse de l'utilisateur
                const { outcome } = await deferredPrompt.userChoice;

                if (outcome === 'accepted') {
                    console.log('üéâ L\'utilisateur a accept√© l\'installation !');
                    showPWAToast('Application install√©e avec succ√®s ! üíï');
                } else {
                    console.log('üëã L\'utilisateur a refus√© l\'installation.');
                }

                // R√©initialiser le prompt
                deferredPrompt = null;
                installBtn.style.display = 'none';
            });
        }

        // --------------------------------------------------------------------
        // 4) D√©tecter si l'app est d√©j√† install√©e (standalone)
        // --------------------------------------------------------------------
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ World of Love a √©t√© install√© avec succ√®s !');

            // Cacher le bouton d'installation
            if (installBtn) {
                installBtn.style.display = 'none';
            }

            deferredPrompt = null;
        });

        // V√©rifier si d√©j√† en mode standalone
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('üì± L\'application est en mode standalone (install√©e).');
            if (installBtn) {
                installBtn.style.display = 'none';
            }
        }

        // --------------------------------------------------------------------
        // 5) Helper pour afficher un toast PWA
        // --------------------------------------------------------------------
        function showPWAToast(message) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<span>üíï</span> ${message}`;
            container.appendChild(toast);

            // Animation d'entr√©e
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Suppression apr√®s 4 secondes
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        console.log('üíï World of Love PWA ready!');
    </script>
</body>

</html>