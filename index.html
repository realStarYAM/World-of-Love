<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description"
        content="World of Love â€” Un jeu de cartes basÃ© sur 196 pays. Collectionnez, Ã©changez et amÃ©liorez vos cartes !">
    <meta name="theme-color" content="#ff6b9d">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WorldLove">

    <!-- Open Graph / Partage social -->
    <meta property="og:title" content="World of Love â€” Card Game">
    <meta property="og:description" content="Jeu de cartes basÃ© sur 196 pays. Collectionnez, Ã©changez et amÃ©liorez !">
    <meta property="og:type" content="website">
    <meta property="og:image" content="icons/icon-512.svg">

    <title>World of Love â€” Card Game</title>

    <!-- Favicon emoji -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’•</text></svg>">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- IcÃ´nes Apple -->
    <link rel="apple-touch-icon" href="icons/icon-192.svg">

    <!-- Styles -->
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app">
        <!-- Header (cachÃ© sur login) -->
        <header id="header">
            <div class="logo">
                <span class="logo-icon">ğŸ’•</span>
                <span>World of Love</span>
            </div>

            <!-- Bouton d'installation PWA -->
            <button id="install-btn" class="install-btn" style="display: none;" aria-label="Installer l'application">
                <span class="install-icon">ğŸ“²</span>
                <span class="install-text">Installer</span>
            </button>

            <nav>
                <button class="nav-item active" data-page="home">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">Accueil</span>
                </button>
                <button class="nav-item" data-page="collection">
                    <span class="nav-icon">ğŸ´</span>
                    <span class="nav-text">Collection</span>
                </button>
                <button class="nav-item" data-page="shop">
                    <span class="nav-icon">ğŸ›’</span>
                    <span class="nav-text">Boutique</span>
                </button>
                <button class="nav-item" data-page="missions">
                    <span class="nav-icon">ğŸ“‹</span>
                    <span class="nav-text">Missions</span>
                </button>
                <button class="nav-item" data-page="profile">
                    <span class="nav-icon">ğŸ‘¤</span>
                    <span class="nav-text">Profil</span>
                </button>
            </nav>
        </header>

        <!-- Contenu principal -->
        <main id="main-content">
            <!-- Le contenu est gÃ©nÃ©rÃ© dynamiquement par JavaScript -->
            <div class="loading">
                <span>ğŸ’•</span>
                <p>Chargement...</p>
            </div>
        </main>
    </div>

    <!-- Container pour les toasts -->
    <div id="toast-container"></div>

    <!-- Script principal (JavaScript compilÃ©) -->
    <script src="dist/main.js"></script>

    <!-- Script PWA : Service Worker + Installation -->
    <script>
        // ========================================================================
        // WORLD OF LOVE â€” PWA SCRIPTS
        // ========================================================================

        // Variable pour stocker l'Ã©vÃ©nement d'installation
        let deferredPrompt = null;
        const installBtn = document.getElementById('install-btn');

        // --------------------------------------------------------------------
        // 1) Enregistrement du Service Worker
        // --------------------------------------------------------------------
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./service-worker.js');
                    console.log('âœ… Service Worker enregistrÃ© avec succÃ¨s:', registration.scope);

                    // Ã‰couter les mises Ã  jour
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('ğŸ”„ Nouvelle version du Service Worker trouvÃ©e...');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('âœ¨ Mise Ã  jour disponible ! Rechargez pour appliquer.');
                                // Optionnel: afficher un toast pour informer l'utilisateur
                                showPWAToast('Mise Ã  jour disponible ! Rechargez la page.');
                            }
                        });
                    });

                } catch (error) {
                    console.error('âŒ Erreur lors de l\'enregistrement du Service Worker:', error);
                }
            });
        }

        // --------------------------------------------------------------------
        // 2) Gestion de l'Ã©vÃ©nement beforeinstallprompt (Chrome/Edge/Android)
        // --------------------------------------------------------------------
        window.addEventListener('beforeinstallprompt', (e) => {
            // EmpÃªcher l'affichage automatique du prompt
            e.preventDefault();

            // Stocker l'Ã©vÃ©nement pour l'utiliser plus tard
            deferredPrompt = e;

            // Afficher le bouton d'installation
            if (installBtn) {
                installBtn.style.display = 'flex';
                installBtn.classList.add('pulse');
                console.log('ğŸ“² Installation disponible ! Bouton affichÃ©.');
            }
        });

        // --------------------------------------------------------------------
        // 3) Clic sur le bouton d'installation
        // --------------------------------------------------------------------
        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) {
                    console.log('âš ï¸ L\'installation n\'est pas disponible.');
                    return;
                }

                // Afficher le prompt d'installation
                deferredPrompt.prompt();

                // Attendre la rÃ©ponse de l'utilisateur
                const { outcome } = await deferredPrompt.userChoice;

                if (outcome === 'accepted') {
                    console.log('ğŸ‰ L\'utilisateur a acceptÃ© l\'installation !');
                    showPWAToast('Application installÃ©e avec succÃ¨s ! ğŸ’•');
                } else {
                    console.log('ğŸ‘‹ L\'utilisateur a refusÃ© l\'installation.');
                }

                // RÃ©initialiser le prompt
                deferredPrompt = null;
                installBtn.style.display = 'none';
            });
        }

        // --------------------------------------------------------------------
        // 4) DÃ©tecter si l'app est dÃ©jÃ  installÃ©e (standalone)
        // --------------------------------------------------------------------
        window.addEventListener('appinstalled', () => {
            console.log('âœ… World of Love a Ã©tÃ© installÃ© avec succÃ¨s !');

            // Cacher le bouton d'installation
            if (installBtn) {
                installBtn.style.display = 'none';
            }

            deferredPrompt = null;
        });

        // VÃ©rifier si dÃ©jÃ  en mode standalone
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('ğŸ“± L\'application est en mode standalone (installÃ©e).');
            if (installBtn) {
                installBtn.style.display = 'none';
            }
        }

        // --------------------------------------------------------------------
        // 5) Helper pour afficher un toast PWA
        // --------------------------------------------------------------------
        function showPWAToast(message) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<span>ğŸ’•</span> ${message}`;
            container.appendChild(toast);

            // Animation d'entrÃ©e
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Suppression aprÃ¨s 4 secondes
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        console.log('ğŸ’• World of Love PWA ready!');
    </script>
</body>

</html>